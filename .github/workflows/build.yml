name: Build GKI Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version to build'
        required: true
      gki_repo:
        description: 'GKI repository URL'
        required: true
      gki_branch:
        description: 'Branch to build from'
        required: true

jobs:
  build-gki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GKI Repo
        uses: actions/checkout@v2
        with:
          repository: ${{ github.event.inputs.gki_repo }}
          ref: ${{ github.event.inputs.gki_branch }}

      - name: Set up the environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git ccache

      - name: Set up CCache
        run: |
          export CCACHE_DIR=$HOME/.ccache
          ccache -M 2G

      - name: Configure Kernel
        run: |
          make ARCH=arm64 O=out gki_defconfig

      - name: Compile Kernel
        run: |
          make -j$(nproc) ARCH=arm64 O=out

      - name: Create Artifact
        run: |
          cp out/arch/arm64/boot/Image.gz out/kernel-gki-${{ github.event.inputs.kernel_version }}.img

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v2
        with:
          name: kernel-gki-${{ github.event.inputs.kernel_version }}.img
          path: out/kernel-gki-${{ github.event.inputs.kernel_version }}.img
